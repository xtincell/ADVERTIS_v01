// ADVERTIS SaaS - Prisma Schema
// Methodology: 8 piliers (A-D-V-E-R-T-I-S)

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ============================================
// AUTH MODELS (NextAuth.js compatible)
// ============================================

model User {
    id            String    @id @default(cuid())
    name          String?
    email         String    @unique
    emailVerified DateTime?
    image         String?
    password      String?   // bcrypt hashed — for Credentials provider
    company       String?
    role          String    @default("user") // user, admin

    accounts   Account[]
    sessions   Session[]
    strategies Strategy[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Account {
    id                       String  @id @default(cuid())
    userId                   String
    type                     String
    provider                 String
    providerAccountId        String
    refresh_token            String? @db.Text
    access_token             String? @db.Text
    expires_at               Int?
    token_type               String?
    scope                    String?
    id_token                 String? @db.Text
    session_state            String?
    refresh_token_expires_in Int?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

// ============================================
// ADVERTIS CORE MODELS
// ============================================

model Strategy {
    id             String  @id @default(cuid())
    name           String // Nom du projet stratégique
    brandName      String // Nom de la marque client
    sector         String? // fashion, fintech, fmcg, b2b-saas, other
    description    String? @db.Text
    status         String  @default("draft") // draft, generating, complete, archived
    phase          String  @default("fiche") // fiche, audit, implementation, cockpit, complete
    coherenceScore Int? // 0-100 Campaign Coherence Score

    // Interview data (structured JSON from wizard)
    interviewData Json?

    // Generation metadata
    generationMode String? // wizard, copilot
    generatedAt    DateTime?

    // Relations
    userId        String
    user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
    pillars       Pillar[]
    documents     Document[]
    cockpitShare  CockpitShare?
    importedFiles ImportedFile[]
    marketStudy   MarketStudy?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([status])
    @@index([phase])
}

model Pillar {
    id      String @id @default(cuid())
    type    String // A, D, V, E, R, T, I, S
    title   String // Authenticité, Distinction, Valeur, Engagement, Risk, Track, Implémentation, Stratégie
    order   Int // 1-8 for sequential generation
    status  String @default("pending") // pending, generating, complete, error
    summary String? @db.Text // Short summary for dashboard card

    // Structured content (variables + AI-generated outputs)
    content Json?

    // Generation metadata
    generatedAt  DateTime?
    errorMessage String?

    // Relations
    strategyId String
    strategy   Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([strategyId, type])
    @@index([strategyId])
}

// ============================================
// REPORT & DOCUMENT MODELS (Phase 3)
// ============================================

model Document {
    id           String  @id @default(cuid())
    type         String // rapport_a, rapport_d, rapport_v, rapport_e, rapport_r, rapport_t
    title        String
    status       String  @default("pending") // pending, generating, complete, error
    content      Json? // Full structured content
    sections     Json? // Array of { title, content, order, wordCount }
    pageCount    Int?
    errorMessage String?

    strategyId String
    strategy   Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

    generatedAt DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    @@unique([strategyId, type])
    @@index([strategyId])
}

// ============================================
// COCKPIT SHARING (Phase 4)
// ============================================

model CockpitShare {
    id        String  @id @default(cuid())
    slug      String  @unique // URL-safe random slug for public link
    password  String // bcrypt hashed password for access control
    isActive  Boolean @default(true)
    viewCount Int     @default(0)

    strategyId String   @unique
    strategy   Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// ============================================
// FILE IMPORT (Phase 1 — Fiche de Marque)
// ============================================

model ImportedFile {
    id            String  @id @default(cuid())
    fileName      String
    fileType      String // xlsx, docx, pdf
    fileSize      Int // bytes
    extractedText String? @db.Text // Raw extracted text from file
    mappedData    Json? // AI-mapped variable values { A1: "...", D3: "...", ... }
    status        String  @default("uploaded") // uploaded, parsing, mapped, confirmed, error
    errorMessage  String?

    strategyId String
    strategy   Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([strategyId])
}

// ============================================
// MARKET STUDY MODULE (between Audit R and Audit T)
// ============================================

model MarketStudy {
    id     String @id @default(cuid())
    status String @default("pending") // pending, collecting, partial, complete, skipped

    // Automated data source results (raw JSON)
    braveSearchResults Json? // Array of search results with queries
    googleTrendsData   Json? // Trend data for brand/sector keywords
    crunchbaseData     Json? // Competitor funding/company data
    similarWebData     Json? // Web traffic analytics
    aiWebSearchResults Json? // Claude web search tool results

    // Per-source collection status
    sourceStatuses Json? // { "brave": "complete", "googleTrends": "error", ... }

    // Manual data input
    manualData    Json? // { internalData: [...], externalData: [...], interviews: [...] }
    uploadedFiles Json? // Array<{ fileName, fileSize, extractedText, uploadedAt }>

    // AI synthesis of all collected data
    synthesis     Json? // MarketStudySynthesis structure with confidence annotations
    synthesizedAt DateTime?

    // Relations
    strategyId String   @unique
    strategy   Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}
